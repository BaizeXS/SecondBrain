<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondBrain API å®æ—¶æµ‹è¯•å™¨ - å¢å¼ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #2196F3;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        .status.success {
            background: #E8F5E9;
            color: #2E7D32;
        }
        .status.error {
            background: #FFEBEE;
            color: #C62828;
        }
        .status.info {
            background: #E3F2FD;
            color: #1565C0;
        }
        #results {
            grid-column: 1 / -1;
            background: #263238;
            color: #ECEFF1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #f5f5f5;
        }
        .tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .quick-action {
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        .quick-action:hover {
            background: #e0e0e0;
        }
        .request-history {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .history-item {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .history-item:hover {
            background: #e3f2fd;
        }
        .json-viewer {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-time {
            color: #607D8B;
            margin-right: 10px;
        }
        .log-success { color: #4CAF50; }
        .log-error { color: #F44336; }
        .log-info { color: #2196F3; }
        .quick-test {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
        }
        .quick-test button {
            margin: 0 5px;
        }
        .token-info {
            background: #E8F5E9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            word-break: break-all;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ SecondBrain API å®æ—¶æµ‹è¯•å™¨</h1>
    
    <div class="quick-test">
        <button onclick="quickTest()">âš¡ ä¸€é”®å¿«é€Ÿæµ‹è¯•</button>
        <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        <button onclick="exportLogs()">ğŸ’¾ å¯¼å‡ºæ—¥å¿—</button>
    </div>
    
    <div class="container">
        <!-- è®¤è¯æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ” è®¤è¯æµ‹è¯•</h2>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="username" value="demo_user">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="password" value="demo123456">
            </div>
            <button onclick="testLogin()">ç™»å½•</button>
            <button onclick="testRegister()">æ³¨å†Œæ–°ç”¨æˆ·</button>
            <div id="authStatus" class="status" style="display:none;"></div>
            <div id="tokenInfo" class="token-info" style="display:none;"></div>
        </div>
        
        <!-- ç©ºé—´ç®¡ç† -->
        <div class="section">
            <h2>ğŸ“ ç©ºé—´ç®¡ç†</h2>
            <div class="form-group">
                <button onclick="testGetSpaces()">è·å–ç©ºé—´åˆ—è¡¨</button>
            </div>
            <div class="form-group">
                <label>æ–°ç©ºé—´åç§°</label>
                <input type="text" id="spaceName" value="æµ‹è¯•ç©ºé—´">
            </div>
            <button onclick="testCreateSpace()">åˆ›å»ºç©ºé—´</button>
            <div class="form-group" style="margin-top: 15px;">
                <label>å½“å‰ç©ºé—´ID</label>
                <input type="text" id="currentSpaceId" readonly>
            </div>
        </div>
        
        <!-- æ–‡æ¡£æ“ä½œ -->
        <div class="section">
            <h2>ğŸ“„ æ–‡æ¡£æ“ä½œ</h2>
            <div class="form-group">
                <label>æœç´¢å…³é”®è¯</label>
                <input type="text" id="searchQuery" value="transformer">
            </div>
            <button onclick="testSearch()">æœç´¢æ–‡æ¡£</button>
            <div class="form-group" style="margin-top: 15px;">
                <label>ä¸Šä¼ æ–‡ä»¶</label>
                <input type="file" id="fileUpload">
            </div>
            <button onclick="testUpload()">ä¸Šä¼ æ–‡æ¡£</button>
        </div>
        
        <!-- AIå¯¹è¯ -->
        <div class="section">
            <h2>ğŸ’¬ AIå¯¹è¯</h2>
            <div class="form-group">
                <label>å¯¹è¯æ¶ˆæ¯</label>
                <textarea id="chatMessage" rows="3">ä»€ä¹ˆæ˜¯æ³¨æ„åŠ›æœºåˆ¶ï¼Ÿ</textarea>
            </div>
            <div class="form-group">
                <label>æ¨¡å‹é€‰æ‹©</label>
                <select id="aiModel">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                </select>
            </div>
            <button onclick="testChat()">å‘é€æ¶ˆæ¯</button>
            <button onclick="testStreamChat()">æµ‹è¯•æµå¼å“åº”</button>
        </div>
        
        <!-- ç»“æœè¾“å‡º -->
        <div id="results">
            <div style="color: #4CAF50; margin-bottom: 10px;">ğŸ“‹ æµ‹è¯•æ—¥å¿—</div>
            <div id="logContent"></div>
        </div>
    </div>
    
    <script>
        // é…ç½®
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = localStorage.getItem('sb_token') || '';
        let currentSpaceId = localStorage.getItem('sb_space_id') || '';
        let currentConversationId = null;
        
        // åˆå§‹åŒ–
        if (token) {
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            document.getElementById('tokenInfo').style.display = 'block';
            document.getElementById('tokenInfo').innerHTML = `Token: ${token.substring(0, 30)}...`;
        }
        if (currentSpaceId) {
            document.getElementById('currentSpaceId').value = currentSpaceId;
        }
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">${timestamp}</span><span class="log-${type}">${message}</span>`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function showStatus(elementId, message, type) {
            const status = document.getElementById(elementId);
            status.style.display = 'block';
            status.className = `status ${type}`;
            status.textContent = message;
            setTimeout(() => { status.style.display = 'none'; }, 5000);
        }
        
        // è®¤è¯åŠŸèƒ½
        async function testLogin() {
            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                log(`æ­£åœ¨ç™»å½•ç”¨æˆ·: ${username}...`);
                
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await axios.post(`${API_BASE}/auth/login`, formData);
                token = response.data.access_token;
                
                // ä¿å­˜token
                localStorage.setItem('sb_token', token);
                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                
                document.getElementById('tokenInfo').style.display = 'block';
                document.getElementById('tokenInfo').innerHTML = `Token: ${token.substring(0, 30)}...`;
                
                log(`âœ… ç™»å½•æˆåŠŸï¼ç”¨æˆ·: ${username}`, 'success');
                showStatus('authStatus', 'ç™»å½•æˆåŠŸï¼', 'success');
                
                // è‡ªåŠ¨è·å–ç©ºé—´åˆ—è¡¨
                await testGetSpaces();
            } catch (error) {
                log(`âŒ ç™»å½•å¤±è´¥: ${error.response?.data?.detail || error.message}`, 'error');
                showStatus('authStatus', `ç™»å½•å¤±è´¥: ${error.response?.data?.detail}`, 'error');
            }
        }
        
        async function testRegister() {
            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const email = `${username}@example.com`;
                
                log(`æ­£åœ¨æ³¨å†Œç”¨æˆ·: ${username}...`);
                
                const response = await axios.post(`${API_BASE}/auth/register`, {
                    username: username,
                    email: email,
                    password: password,
                    full_name: 'æµ‹è¯•ç”¨æˆ·'
                });
                
                log(`âœ… æ³¨å†ŒæˆåŠŸï¼ç”¨æˆ·ID: ${response.data.id}`, 'success');
                showStatus('authStatus', 'æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');
            } catch (error) {
                log(`âŒ æ³¨å†Œå¤±è´¥: ${error.response?.data?.detail || error.message}`, 'error');
                showStatus('authStatus', `æ³¨å†Œå¤±è´¥: ${error.response?.data?.detail}`, 'error');
            }
        }
        
        // ç©ºé—´ç®¡ç†
        async function testGetSpaces() {
            try {
                log('è·å–ç©ºé—´åˆ—è¡¨...');
                const response = await axios.get(`${API_BASE}/spaces/`);
                const spaces = response.data.spaces || [];
                
                log(`âœ… æ‰¾åˆ° ${spaces.length} ä¸ªç©ºé—´:`, 'success');
                spaces.forEach(space => {
                    log(`  ğŸ“ ${space.name} (ID: ${space.id})`, 'info');
                });
                
                // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªç©ºé—´
                if (spaces.length > 0 && !currentSpaceId) {
                    currentSpaceId = spaces[0].id;
                    localStorage.setItem('sb_space_id', currentSpaceId);
                    document.getElementById('currentSpaceId').value = currentSpaceId;
                    log(`è‡ªåŠ¨é€‰æ‹©ç©ºé—´: ${spaces[0].name}`, 'info');
                }
            } catch (error) {
                log(`âŒ è·å–ç©ºé—´å¤±è´¥: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        async function testCreateSpace() {
            try {
                const name = document.getElementById('spaceName').value;
                log(`åˆ›å»ºç©ºé—´: ${name}...`);
                
                const response = await axios.post(`${API_BASE}/spaces/`, {
                    name: name,
                    description: 'é€šè¿‡APIæµ‹è¯•å™¨åˆ›å»º',
                    color: '#4CAF50',
                    icon: 'ğŸ§ª'
                });
                
                currentSpaceId = response.data.id;
                localStorage.setItem('sb_space_id', currentSpaceId);
                document.getElementById('currentSpaceId').value = currentSpaceId;
                
                log(`âœ… ç©ºé—´åˆ›å»ºæˆåŠŸï¼ID: ${currentSpaceId}`, 'success');
            } catch (error) {
                log(`âŒ åˆ›å»ºç©ºé—´å¤±è´¥: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        // æ–‡æ¡£æ“ä½œ
        async function testSearch() {
            try {
                const query = document.getElementById('searchQuery').value;
                log(`æœç´¢æ–‡æ¡£: "${query}"...`);
                
                const response = await axios.post(`${API_BASE}/documents/search`, {
                    query: query,
                    limit: 5,
                    space_id: currentSpaceId ? parseInt(currentSpaceId) : null
                });
                
                const results = response.data.results || [];
                log(`âœ… æ‰¾åˆ° ${results.length} ä¸ªç»“æœ:`, 'success');
                results.forEach(r => {
                    log(`  ğŸ“„ ${r.title} (ç›¸å…³åº¦: ${r.score.toFixed(2)})`, 'info');
                });
            } catch (error) {
                log(`âŒ æœç´¢å¤±è´¥: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        async function testUpload() {
            try {
                const fileInput = document.getElementById('fileUpload');
                if (!fileInput.files[0]) {
                    log('âŒ è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
                    return;
                }
                
                if (!currentSpaceId) {
                    log('âŒ è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªç©ºé—´', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                log(`ä¸Šä¼ æ–‡ä»¶: ${file.name}...`);
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('space_id', currentSpaceId);
                
                const response = await axios.post(`${API_BASE}/documents/upload`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                log(`âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼æ–‡æ¡£ID: ${response.data.id}`, 'success');
            } catch (error) {
                log(`âŒ ä¸Šä¼ å¤±è´¥: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        // AIå¯¹è¯
        async function testChat() {
            try {
                const message = document.getElementById('chatMessage').value;
                const model = document.getElementById('aiModel').value;
                
                // å¦‚æœæ²¡æœ‰å¯¹è¯ï¼Œå…ˆåˆ›å»º
                if (!currentConversationId) {
                    log('åˆ›å»ºæ–°å¯¹è¯...');
                    const convResponse = await axios.post(`${API_BASE}/chat/conversations`, {
                        title: 'APIæµ‹è¯•å¯¹è¯',
                        mode: 'chat',
                        model: model,
                        space_id: currentSpaceId ? parseInt(currentSpaceId) : null
                    });
                    currentConversationId = convResponse.data.id;
                    log(`å¯¹è¯åˆ›å»ºæˆåŠŸï¼ID: ${currentConversationId}`, 'info');
                }
                
                log(`å‘é€æ¶ˆæ¯: "${message}"...`);
                
                const response = await axios.post(`${API_BASE}/chat/completions`, {
                    conversation_id: currentConversationId,
                    messages: [
                        {role: 'user', content: message}
                    ],
                    model: model,
                    stream: false
                });
                
                const aiResponse = response.data.choices[0].message.content;
                log(`âœ… AIå›å¤:`, 'success');
                log(aiResponse.substring(0, 300) + (aiResponse.length > 300 ? '...' : ''), 'info');
            } catch (error) {
                log(`âŒ å¯¹è¯å¤±è´¥: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        async function testStreamChat() {
            try {
                const message = document.getElementById('chatMessage').value;
                const model = document.getElementById('aiModel').value;
                
                log(`æµ‹è¯•æµå¼å“åº”: "${message}"...`);
                log('âš ï¸ æµå¼å“åº”éœ€è¦EventSourceæ”¯æŒï¼Œæ­¤å¤„ä»…æ¼”ç¤ºè¯·æ±‚', 'info');
                
                // å®é™…çš„æµå¼å“åº”éœ€è¦ä½¿ç”¨EventSource
                // è¿™é‡Œåªæ˜¯æ¼”ç¤ºå¦‚ä½•æ„å»ºè¯·æ±‚
                const streamUrl = `${API_BASE}/chat/completions`;
                log(`æµå¼ç«¯ç‚¹: ${streamUrl}`, 'info');
                log('åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½¿ç”¨ new EventSource(url) æ¥æ”¶æµå¼æ•°æ®', 'info');
            } catch (error) {
                log(`âŒ æµå¼æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å·¥å…·å‡½æ•°
        async function quickTest() {
            log('========== å¼€å§‹å¿«é€Ÿæµ‹è¯• ==========', 'success');
            await testLogin();
            setTimeout(async () => {
                await testGetSpaces();
                setTimeout(async () => {
                    await testSearch();
                    setTimeout(async () => {
                        await testChat();
                        log('========== å¿«é€Ÿæµ‹è¯•å®Œæˆ ==========', 'success');
                    }, 1000);
                }, 1000);
            }, 1000);
        }
        
        function clearLogs() {
            document.getElementById('logContent').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        function exportLogs() {
            const logs = document.getElementById('logContent').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api_test_logs_${new Date().toISOString()}.txt`;
            a.click();
            log('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = () => {
            log('SecondBrain APIæµ‹è¯•å™¨å·²å°±ç»ª', 'success');
            log(`APIç«¯ç‚¹: ${API_BASE}`, 'info');
            if (token) {
                log('å·²åŠ è½½ä¿å­˜çš„è®¤è¯ä¿¡æ¯', 'info');
            } else {
                log('è¯·å…ˆç™»å½•ä»¥æµ‹è¯•APIåŠŸèƒ½', 'info');
            }
        };
    </script>
</body>
</html>