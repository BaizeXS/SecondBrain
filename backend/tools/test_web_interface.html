<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondBrain API 实时测试器 - 增强版</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #2196F3;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        .status.success {
            background: #E8F5E9;
            color: #2E7D32;
        }
        .status.error {
            background: #FFEBEE;
            color: #C62828;
        }
        .status.info {
            background: #E3F2FD;
            color: #1565C0;
        }
        #results {
            grid-column: 1 / -1;
            background: #263238;
            color: #ECEFF1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #f5f5f5;
        }
        .tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .quick-action {
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        .quick-action:hover {
            background: #e0e0e0;
        }
        .request-history {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .history-item {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .history-item:hover {
            background: #e3f2fd;
        }
        .json-viewer {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-time {
            color: #607D8B;
            margin-right: 10px;
        }
        .log-success { color: #4CAF50; }
        .log-error { color: #F44336; }
        .log-info { color: #2196F3; }
        .quick-test {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
        }
        .quick-test button {
            margin: 0 5px;
        }
        .token-info {
            background: #E8F5E9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            word-break: break-all;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🚀 SecondBrain API 实时测试器</h1>
    
    <div class="quick-test">
        <button onclick="quickTest()">⚡ 一键快速测试</button>
        <button onclick="clearLogs()">🗑️ 清空日志</button>
        <button onclick="exportLogs()">💾 导出日志</button>
    </div>
    
    <div class="container">
        <!-- 认证测试 -->
        <div class="section">
            <h2>🔐 认证测试</h2>
            <div class="form-group">
                <label>用户名</label>
                <input type="text" id="username" value="demo_user">
            </div>
            <div class="form-group">
                <label>密码</label>
                <input type="password" id="password" value="demo123456">
            </div>
            <button onclick="testLogin()">登录</button>
            <button onclick="testRegister()">注册新用户</button>
            <div id="authStatus" class="status" style="display:none;"></div>
            <div id="tokenInfo" class="token-info" style="display:none;"></div>
        </div>
        
        <!-- 空间管理 -->
        <div class="section">
            <h2>📁 空间管理</h2>
            <div class="form-group">
                <button onclick="testGetSpaces()">获取空间列表</button>
            </div>
            <div class="form-group">
                <label>新空间名称</label>
                <input type="text" id="spaceName" value="测试空间">
            </div>
            <button onclick="testCreateSpace()">创建空间</button>
            <div class="form-group" style="margin-top: 15px;">
                <label>当前空间ID</label>
                <input type="text" id="currentSpaceId" readonly>
            </div>
        </div>
        
        <!-- 文档操作 -->
        <div class="section">
            <h2>📄 文档操作</h2>
            <div class="form-group">
                <label>搜索关键词</label>
                <input type="text" id="searchQuery" value="transformer">
            </div>
            <button onclick="testSearch()">搜索文档</button>
            <div class="form-group" style="margin-top: 15px;">
                <label>上传文件</label>
                <input type="file" id="fileUpload">
            </div>
            <button onclick="testUpload()">上传文档</button>
        </div>
        
        <!-- AI对话 -->
        <div class="section">
            <h2>💬 AI对话</h2>
            <div class="form-group">
                <label>对话消息</label>
                <textarea id="chatMessage" rows="3">什么是注意力机制？</textarea>
            </div>
            <div class="form-group">
                <label>模型选择</label>
                <select id="aiModel">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                </select>
            </div>
            <button onclick="testChat()">发送消息</button>
            <button onclick="testStreamChat()">测试流式响应</button>
        </div>
        
        <!-- 结果输出 -->
        <div id="results">
            <div style="color: #4CAF50; margin-bottom: 10px;">📋 测试日志</div>
            <div id="logContent"></div>
        </div>
    </div>
    
    <script>
        // 配置
        const API_BASE = 'http://localhost:8000/api/v1';
        let token = localStorage.getItem('sb_token') || '';
        let currentSpaceId = localStorage.getItem('sb_space_id') || '';
        let currentConversationId = null;
        
        // 初始化
        if (token) {
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            document.getElementById('tokenInfo').style.display = 'block';
            document.getElementById('tokenInfo').innerHTML = `Token: ${token.substring(0, 30)}...`;
        }
        if (currentSpaceId) {
            document.getElementById('currentSpaceId').value = currentSpaceId;
        }
        
        // 日志函数
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">${timestamp}</span><span class="log-${type}">${message}</span>`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function showStatus(elementId, message, type) {
            const status = document.getElementById(elementId);
            status.style.display = 'block';
            status.className = `status ${type}`;
            status.textContent = message;
            setTimeout(() => { status.style.display = 'none'; }, 5000);
        }
        
        // 认证功能
        async function testLogin() {
            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                log(`正在登录用户: ${username}...`);
                
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await axios.post(`${API_BASE}/auth/login`, formData);
                token = response.data.access_token;
                
                // 保存token
                localStorage.setItem('sb_token', token);
                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                
                document.getElementById('tokenInfo').style.display = 'block';
                document.getElementById('tokenInfo').innerHTML = `Token: ${token.substring(0, 30)}...`;
                
                log(`✅ 登录成功！用户: ${username}`, 'success');
                showStatus('authStatus', '登录成功！', 'success');
                
                // 自动获取空间列表
                await testGetSpaces();
            } catch (error) {
                log(`❌ 登录失败: ${error.response?.data?.detail || error.message}`, 'error');
                showStatus('authStatus', `登录失败: ${error.response?.data?.detail}`, 'error');
            }
        }
        
        async function testRegister() {
            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const email = `${username}@example.com`;
                
                log(`正在注册用户: ${username}...`);
                
                const response = await axios.post(`${API_BASE}/auth/register`, {
                    username: username,
                    email: email,
                    password: password,
                    full_name: '测试用户'
                });
                
                log(`✅ 注册成功！用户ID: ${response.data.id}`, 'success');
                showStatus('authStatus', '注册成功！请登录', 'success');
            } catch (error) {
                log(`❌ 注册失败: ${error.response?.data?.detail || error.message}`, 'error');
                showStatus('authStatus', `注册失败: ${error.response?.data?.detail}`, 'error');
            }
        }
        
        // 空间管理
        async function testGetSpaces() {
            try {
                log('获取空间列表...');
                const response = await axios.get(`${API_BASE}/spaces/`);
                const spaces = response.data.spaces || [];
                
                log(`✅ 找到 ${spaces.length} 个空间:`, 'success');
                spaces.forEach(space => {
                    log(`  📁 ${space.name} (ID: ${space.id})`, 'info');
                });
                
                // 自动选择第一个空间
                if (spaces.length > 0 && !currentSpaceId) {
                    currentSpaceId = spaces[0].id;
                    localStorage.setItem('sb_space_id', currentSpaceId);
                    document.getElementById('currentSpaceId').value = currentSpaceId;
                    log(`自动选择空间: ${spaces[0].name}`, 'info');
                }
            } catch (error) {
                log(`❌ 获取空间失败: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        async function testCreateSpace() {
            try {
                const name = document.getElementById('spaceName').value;
                log(`创建空间: ${name}...`);
                
                const response = await axios.post(`${API_BASE}/spaces/`, {
                    name: name,
                    description: '通过API测试器创建',
                    color: '#4CAF50',
                    icon: '🧪'
                });
                
                currentSpaceId = response.data.id;
                localStorage.setItem('sb_space_id', currentSpaceId);
                document.getElementById('currentSpaceId').value = currentSpaceId;
                
                log(`✅ 空间创建成功！ID: ${currentSpaceId}`, 'success');
            } catch (error) {
                log(`❌ 创建空间失败: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        // 文档操作
        async function testSearch() {
            try {
                const query = document.getElementById('searchQuery').value;
                log(`搜索文档: "${query}"...`);
                
                const response = await axios.post(`${API_BASE}/documents/search`, {
                    query: query,
                    limit: 5,
                    space_id: currentSpaceId ? parseInt(currentSpaceId) : null
                });
                
                const results = response.data.results || [];
                log(`✅ 找到 ${results.length} 个结果:`, 'success');
                results.forEach(r => {
                    log(`  📄 ${r.title} (相关度: ${r.score.toFixed(2)})`, 'info');
                });
            } catch (error) {
                log(`❌ 搜索失败: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        async function testUpload() {
            try {
                const fileInput = document.getElementById('fileUpload');
                if (!fileInput.files[0]) {
                    log('❌ 请选择要上传的文件', 'error');
                    return;
                }
                
                if (!currentSpaceId) {
                    log('❌ 请先选择或创建一个空间', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                log(`上传文件: ${file.name}...`);
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('space_id', currentSpaceId);
                
                const response = await axios.post(`${API_BASE}/documents/upload`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                log(`✅ 文件上传成功！文档ID: ${response.data.id}`, 'success');
            } catch (error) {
                log(`❌ 上传失败: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        // AI对话
        async function testChat() {
            try {
                const message = document.getElementById('chatMessage').value;
                const model = document.getElementById('aiModel').value;
                
                // 如果没有对话，先创建
                if (!currentConversationId) {
                    log('创建新对话...');
                    const convResponse = await axios.post(`${API_BASE}/chat/conversations`, {
                        title: 'API测试对话',
                        mode: 'chat',
                        model: model,
                        space_id: currentSpaceId ? parseInt(currentSpaceId) : null
                    });
                    currentConversationId = convResponse.data.id;
                    log(`对话创建成功！ID: ${currentConversationId}`, 'info');
                }
                
                log(`发送消息: "${message}"...`);
                
                const response = await axios.post(`${API_BASE}/chat/completions`, {
                    conversation_id: currentConversationId,
                    messages: [
                        {role: 'user', content: message}
                    ],
                    model: model,
                    stream: false
                });
                
                const aiResponse = response.data.choices[0].message.content;
                log(`✅ AI回复:`, 'success');
                log(aiResponse.substring(0, 300) + (aiResponse.length > 300 ? '...' : ''), 'info');
            } catch (error) {
                log(`❌ 对话失败: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        async function testStreamChat() {
            try {
                const message = document.getElementById('chatMessage').value;
                const model = document.getElementById('aiModel').value;
                
                log(`测试流式响应: "${message}"...`);
                log('⚠️ 流式响应需要EventSource支持，此处仅演示请求', 'info');
                
                // 实际的流式响应需要使用EventSource
                // 这里只是演示如何构建请求
                const streamUrl = `${API_BASE}/chat/completions`;
                log(`流式端点: ${streamUrl}`, 'info');
                log('在实际应用中，使用 new EventSource(url) 接收流式数据', 'info');
            } catch (error) {
                log(`❌ 流式测试失败: ${error.message}`, 'error');
            }
        }
        
        // 工具函数
        async function quickTest() {
            log('========== 开始快速测试 ==========', 'success');
            await testLogin();
            setTimeout(async () => {
                await testGetSpaces();
                setTimeout(async () => {
                    await testSearch();
                    setTimeout(async () => {
                        await testChat();
                        log('========== 快速测试完成 ==========', 'success');
                    }, 1000);
                }, 1000);
            }, 1000);
        }
        
        function clearLogs() {
            document.getElementById('logContent').innerHTML = '';
            log('日志已清空', 'info');
        }
        
        function exportLogs() {
            const logs = document.getElementById('logContent').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api_test_logs_${new Date().toISOString()}.txt`;
            a.click();
            log('日志已导出', 'success');
        }
        
        // 页面加载完成
        window.onload = () => {
            log('SecondBrain API测试器已就绪', 'success');
            log(`API端点: ${API_BASE}`, 'info');
            if (token) {
                log('已加载保存的认证信息', 'info');
            } else {
                log('请先登录以测试API功能', 'info');
            }
        };
    </script>
</body>
</html>