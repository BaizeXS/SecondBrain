<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecondBrain API 测试控制台 - 增强版</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet" />
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #333;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        .header-stats {
            display: flex;
            gap: 30px;
        }
        .header-stat {
            text-align: center;
        }
        .header-stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .header-stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Main Layout */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab {
            flex: 1;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s;
            font-weight: 500;
        }
        .tab:hover {
            background: #f5f5f5;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        .btn-success {
            background: #48bb78;
            color: white;
        }
        .btn-success:hover {
            background: #38a169;
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .btn-danger:hover {
            background: #e53e3e;
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .quick-action {
            padding: 8px 16px;
            background: #edf2f7;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .quick-action:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        /* Status Messages */
        .status {
            padding: 12px 16px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-success {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #bbf7d0;
        }
        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .status-info {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .status-warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }
        
        /* Log Viewer */
        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .log-time {
            color: #808080;
            min-width: 80px;
        }
        .log-level {
            min-width: 60px;
            font-weight: bold;
        }
        .log-level.success { color: #4ec9b0; }
        .log-level.error { color: #f48771; }
        .log-level.info { color: #569cd6; }
        .log-level.warning { color: #dcdcaa; }
        .log-message {
            flex: 1;
            word-wrap: break-word;
        }
        
        /* Request Builder */
        .request-builder {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 10px;
            align-items: start;
        }
        .method-select {
            padding: 10px;
            font-weight: bold;
        }
        .url-input {
            display: flex;
            gap: 10px;
        }
        .url-input input {
            flex: 1;
        }
        
        /* Response Viewer */
        .response-viewer {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        .response-header {
            background: #f5f5f5;
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .response-status {
            font-weight: bold;
        }
        .response-status.ok { color: #48bb78; }
        .response-status.error { color: #f56565; }
        .response-body {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* JSON Viewer */
        .json-viewer {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
        }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Request History */
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:hover {
            background: #f5f5f5;
        }
        .history-method {
            font-weight: bold;
            margin-right: 10px;
        }
        .history-method.GET { color: #48bb78; }
        .history-method.POST { color: #4299e1; }
        .history-method.PUT { color: #ed8936; }
        .history-method.DELETE { color: #f56565; }
        .history-url {
            flex: 1;
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-time {
            font-size: 12px;
            color: #999;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            border-radius: 10px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .modal-close:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>🚀 SecondBrain API 测试控制台</h1>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-value" id="totalRequests">0</div>
                    <div class="header-stat-label">总请求数</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="successRate">0%</div>
                    <div class="header-stat-label">成功率</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="avgResponseTime">0ms</div>
                    <div class="header-stat-label">平均响应时间</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action" onclick="runQuickTest()">
                ⚡ 快速测试
            </div>
            <div class="quick-action" onclick="runFullTest()">
                🔍 完整测试
            </div>
            <div class="quick-action" onclick="testPerformance()">
                📊 性能测试
            </div>
            <div class="quick-action" onclick="clearHistory()">
                🗑️ 清空历史
            </div>
            <div class="quick-action" onclick="exportResults()">
                💾 导出结果
            </div>
            <div class="quick-action" onclick="showAPIDoc()">
                📚 API文档
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('basic')">基础测试</div>
            <div class="tab" onclick="switchTab('advanced')">高级测试</div>
            <div class="tab" onclick="switchTab('batch')">批量测试</div>
            <div class="tab" onclick="switchTab('monitor')">监控面板</div>
            <div class="tab" onclick="switchTab('history')">请求历史</div>
        </div>

        <!-- Tab Contents -->
        <!-- Basic Test Tab -->
        <div id="basic-tab" class="tab-content active">
            <div class="grid-2">
                <!-- Authentication Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🔐 认证测试</h3>
                        <span id="authStatusBadge" class="status-badge"></span>
                    </div>
                    <div class="form-group">
                        <label>用户名</label>
                        <input type="text" id="username" value="demo_user" placeholder="输入用户名">
                    </div>
                    <div class="form-group">
                        <label>密码</label>
                        <input type="password" id="password" value="Demo123456!" placeholder="输入密码">
                    </div>
                    <div class="form-group">
                        <label>邮箱（仅注册）</label>
                        <input type="email" id="email" placeholder="user@example.com">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="testLogin()">
                            🔓 登录
                        </button>
                        <button class="btn btn-success" onclick="testRegister()">
                            ✨ 注册
                        </button>
                        <button class="btn btn-secondary" onclick="refreshToken()">
                            🔄 刷新Token
                        </button>
                    </div>
                    <div id="authStatus" style="margin-top: 10px;"></div>
                </div>

                <!-- Space Management Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📁 空间管理</h3>
                    </div>
                    <div class="form-group">
                        <label>空间名称</label>
                        <input type="text" id="spaceName" value="测试空间" placeholder="输入空间名称">
                    </div>
                    <div class="form-group">
                        <label>空间描述</label>
                        <textarea id="spaceDescription" rows="2" placeholder="输入空间描述">这是一个测试空间</textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="createSpace()">
                            ➕ 创建空间
                        </button>
                        <button class="btn btn-secondary" onclick="listSpaces()">
                            📋 列出空间
                        </button>
                    </div>
                    <div class="form-group">
                        <label>当前空间</label>
                        <select id="currentSpace" onchange="selectSpace()">
                            <option value="">选择空间...</option>
                        </select>
                    </div>
                    <div id="spaceStatus"></div>
                </div>

                <!-- Document Operations Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📄 文档操作</h3>
                    </div>
                    <div class="form-group">
                        <label>上传文件</label>
                        <input type="file" id="fileUpload" accept=".pdf,.txt,.docx,.md">
                    </div>
                    <button class="btn btn-primary" onclick="uploadDocument()">
                        📤 上传文档
                    </button>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>搜索关键词</label>
                        <input type="text" id="searchQuery" value="AI" placeholder="输入搜索关键词">
                    </div>
                    <button class="btn btn-secondary" onclick="searchDocuments()">
                        🔍 搜索文档
                    </button>
                    <div id="documentStatus"></div>
                </div>

                <!-- AI Chat Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">💬 AI对话</h3>
                    </div>
                    <div class="form-group">
                        <label>模型选择</label>
                        <select id="aiModel">
                            <option value="openrouter/auto">OpenRouter Auto</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                            <option value="deepseek-chat">DeepSeek Chat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>消息内容</label>
                        <textarea id="chatMessage" rows="3" placeholder="输入消息...">什么是注意力机制？</textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableSearch" checked> 启用搜索增强
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="sendChat()">
                            💬 发送消息
                        </button>
                        <button class="btn btn-success" onclick="sendStreamChat()">
                            🌊 流式对话
                        </button>
                    </div>
                    <div id="chatResponse" class="response-viewer" style="margin-top: 15px; display: none;">
                        <div class="response-header">
                            <span>AI响应</span>
                            <span id="chatResponseTime"></span>
                        </div>
                        <div class="response-body" id="chatResponseBody"></div>
                    </div>
                </div>
            </div>

            <!-- Log Viewer -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3 class="card-title">📋 实时日志</h3>
                    <button class="btn btn-secondary" onclick="clearLogs()">清空</button>
                </div>
                <div class="log-viewer" id="logViewer"></div>
            </div>
        </div>

        <!-- Advanced Test Tab -->
        <div id="advanced-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🛠️ 自定义请求构建器</h3>
                </div>
                <div class="request-builder">
                    <select id="requestMethod" class="method-select">
                        <option value="GET" style="color: #48bb78;">GET</option>
                        <option value="POST" style="color: #4299e1;">POST</option>
                        <option value="PUT" style="color: #ed8936;">PUT</option>
                        <option value="DELETE" style="color: #f56565;">DELETE</option>
                        <option value="PATCH" style="color: #805ad5;">PATCH</option>
                    </select>
                    <div class="url-input">
                        <input type="text" id="requestUrl" placeholder="/api/v1/..." value="/api/v1/spaces">
                        <button class="btn btn-primary" onclick="sendCustomRequest()">发送</button>
                    </div>
                </div>
                
                <div class="grid-2" style="margin-top: 20px;">
                    <div>
                        <h4>请求头</h4>
                        <textarea id="requestHeaders" rows="5" placeholder='{"Content-Type": "application/json"}'>{
  "Content-Type": "application/json"
}</textarea>
                    </div>
                    <div>
                        <h4>请求体</h4>
                        <textarea id="requestBody" rows="5" placeholder='{"key": "value"}'>{}</textarea>
                    </div>
                </div>
                
                <div class="response-viewer" style="margin-top: 20px;">
                    <div class="response-header">
                        <span>响应 <span id="responseStatus"></span></span>
                        <span id="responseTime"></span>
                    </div>
                    <div class="response-body">
                        <pre><code id="responseBody" class="language-json"></code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batch Test Tab -->
        <div id="batch-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">🔄 批量测试</h3>
                </div>
                <div class="grid-2">
                    <div>
                        <h4>测试场景</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" checked> 认证流程
                            </label>
                            <label>
                                <input type="checkbox" checked> 空间管理
                            </label>
                            <label>
                                <input type="checkbox" checked> 文档操作
                            </label>
                            <label>
                                <input type="checkbox" checked> AI对话
                            </label>
                            <label>
                                <input type="checkbox" checked> 深度研究
                            </label>
                            <label>
                                <input type="checkbox"> 性能测试
                            </label>
                        </div>
                    </div>
                    <div>
                        <h4>测试配置</h4>
                        <div class="form-group">
                            <label>并发数</label>
                            <input type="number" id="concurrency" value="5" min="1" max="50">
                        </div>
                        <div class="form-group">
                            <label>重复次数</label>
                            <input type="number" id="iterations" value="1" min="1" max="100">
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="runBatchTest()">
                    🚀 开始批量测试
                </button>
                <div id="batchProgress" style="margin-top: 20px; display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <span id="progressText">0 / 0</span>
                    </div>
                </div>
                <div id="batchResults" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Monitor Tab -->
        <div id="monitor-tab" class="tab-content">
            <div class="grid-4">
                <div class="card">
                    <div class="card-title">总请求数</div>
                    <div style="font-size: 32px; font-weight: bold; color: #667eea;" id="monitorTotalRequests">0</div>
                </div>
                <div class="card">
                    <div class="card-title">成功率</div>
                    <div style="font-size: 32px; font-weight: bold; color: #48bb78;" id="monitorSuccessRate">0%</div>
                </div>
                <div class="card">
                    <div class="card-title">平均响应时间</div>
                    <div style="font-size: 32px; font-weight: bold; color: #ed8936;" id="monitorAvgTime">0ms</div>
                </div>
                <div class="card">
                    <div class="card-title">错误数</div>
                    <div style="font-size: 32px; font-weight: bold; color: #f56565;" id="monitorErrors">0</div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">响应时间趋势</h3>
                <div class="chart-container">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <h3 class="card-title">请求方法分布</h3>
                    <div class="chart-container">
                        <canvas id="methodChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">状态码分布</h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📜 请求历史</h3>
                    <div>
                        <input type="text" placeholder="搜索..." id="historySearch" style="width: 200px; margin-right: 10px;">
                        <button class="btn btn-secondary" onclick="clearHistory()">清空历史</button>
                    </div>
                </div>
                <div id="historyList" style="max-height: 600px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">标题</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000/api/v1';
        const BASE_URL = 'http://localhost:8000';
        
        // State
        let authToken = localStorage.getItem('sb_token') || '';
        let currentSpaceId = localStorage.getItem('sb_space_id') || '';
        let requestHistory = JSON.parse(localStorage.getItem('sb_history') || '[]');
        let stats = {
            totalRequests: 0,
            successCount: 0,
            errorCount: 0,
            totalResponseTime: 0,
            methodCounts: {},
            statusCounts: {},
            responseTimes: []
        };
        
        // Charts
        let responseTimeChart = null;
        let methodChart = null;
        let statusChart = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            initializeCharts();
        });
        
        function initializeApp() {
            // Set auth header if token exists
            if (authToken) {
                axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;
                log('已加载保存的认证Token', 'info');
            }
            
            // Load current space
            if (currentSpaceId) {
                log(`已加载当前空间: ${currentSpaceId}`, 'info');
            }
            
            // Update stats
            updateStats();
            
            // Load history
            displayHistory();
        }
        
        function initializeCharts() {
            // Response Time Chart
            const rtCtx = document.getElementById('responseTimeChart')?.getContext('2d');
            if (rtCtx) {
                responseTimeChart = new Chart(rtCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '响应时间 (ms)',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Method Distribution Chart
            const methodCtx = document.getElementById('methodChart')?.getContext('2d');
            if (methodCtx) {
                methodChart = new Chart(methodCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['GET', 'POST', 'PUT', 'DELETE'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: ['#48bb78', '#4299e1', '#ed8936', '#f56565']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Status Code Chart
            const statusCtx = document.getElementById('statusChart')?.getContext('2d');
            if (statusCtx) {
                statusChart = new Chart(statusCtx, {
                    type: 'bar',
                    data: {
                        labels: ['2xx', '3xx', '4xx', '5xx'],
                        datasets: [{
                            label: '状态码',
                            data: [0, 0, 0, 0],
                            backgroundColor: ['#48bb78', '#4299e1', '#ed8936', '#f56565']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }
        
        // Logging
        function log(message, level = 'info') {
            const logViewer = document.getElementById('logViewer');
            if (!logViewer) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const levelText = level.toUpperCase().padEnd(7);
            const levelClass = `log-level ${level}`;
            
            entry.innerHTML = `
                <span class="log-time">${timestamp}</span>
                <span class="${levelClass}">${levelText}</span>
                <span class="log-message">${message}</span>
            `;
            
            logViewer.appendChild(entry);
            logViewer.scrollTop = logViewer.scrollHeight;
        }
        
        function clearLogs() {
            const logViewer = document.getElementById('logViewer');
            if (logViewer) {
                logViewer.innerHTML = '';
                log('日志已清空', 'info');
            }
        }
        
        // Tab Switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Special handling for monitor tab
            if (tabName === 'monitor') {
                updateCharts();
            }
        }
        
        // Authentication Functions
        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showStatus('authStatus', '请输入用户名和密码', 'error');
                return;
            }
            
            log(`正在登录: ${username}`, 'info');
            const startTime = Date.now();
            
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await makeRequest('POST', '/auth/login', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                
                if (response.data.access_token) {
                    authToken = response.data.access_token;
                    localStorage.setItem('sb_token', authToken);
                    axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;
                    
                    log(`登录成功! 用户: ${username}`, 'success');
                    showStatus('authStatus', '登录成功!', 'success');
                    
                    // Auto load spaces
                    await listSpaces();
                }
            } catch (error) {
                log(`登录失败: ${error.response?.data?.detail || error.message}`, 'error');
                showStatus('authStatus', `登录失败: ${error.response?.data?.detail}`, 'error');
            }
        }
        
        async function testRegister() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value || `${username}@example.com`;
            
            if (!username || !password) {
                showStatus('authStatus', '请输入用户名和密码', 'error');
                return;
            }
            
            log(`正在注册用户: ${username}`, 'info');
            
            try {
                const response = await makeRequest('POST', '/auth/register', {
                    username,
                    email,
                    password,
                    full_name: username
                });
                
                log(`注册成功! 用户ID: ${response.data.id}`, 'success');
                showStatus('authStatus', '注册成功! 请登录', 'success');
            } catch (error) {
                log(`注册失败: ${error.response?.data?.detail || error.message}`, 'error');
                showStatus('authStatus', `注册失败: ${error.response?.data?.detail}`, 'error');
            }
        }
        
        async function refreshToken() {
            // TODO: Implement token refresh
            log('Token刷新功能待实现', 'warning');
        }
        
        // Space Functions
        async function createSpace() {
            const name = document.getElementById('spaceName').value;
            const description = document.getElementById('spaceDescription').value;
            
            if (!name) {
                showStatus('spaceStatus', '请输入空间名称', 'error');
                return;
            }
            
            log(`正在创建空间: ${name}`, 'info');
            
            try {
                const response = await makeRequest('POST', '/spaces', {
                    name,
                    description
                });
                
                log(`空间创建成功! ID: ${response.data.id}`, 'success');
                showStatus('spaceStatus', '空间创建成功!', 'success');
                
                // Refresh space list
                await listSpaces();
                
                // Select the new space
                currentSpaceId = response.data.id;
                localStorage.setItem('sb_space_id', currentSpaceId);
                document.getElementById('currentSpace').value = currentSpaceId;
            } catch (error) {
                log(`创建空间失败: ${error.response?.data?.detail || error.message}`, 'error');
                showStatus('spaceStatus', `创建失败: ${error.response?.data?.detail}`, 'error');
            }
        }
        
        async function listSpaces() {
            log('获取空间列表...', 'info');
            
            try {
                const response = await makeRequest('GET', '/spaces');
                const spaces = response.data;
                
                log(`获取到 ${spaces.length} 个空间`, 'success');
                
                // Update space selector
                const selector = document.getElementById('currentSpace');
                selector.innerHTML = '<option value="">选择空间...</option>';
                
                spaces.forEach(space => {
                    const option = document.createElement('option');
                    option.value = space.id;
                    option.textContent = `${space.name} (ID: ${space.id})`;
                    selector.appendChild(option);
                });
                
                // Select current space if exists
                if (currentSpaceId) {
                    selector.value = currentSpaceId;
                }
            } catch (error) {
                log(`获取空间失败: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        function selectSpace() {
            const selector = document.getElementById('currentSpace');
            currentSpaceId = selector.value;
            localStorage.setItem('sb_space_id', currentSpaceId);
            log(`已选择空间: ${currentSpaceId}`, 'info');
        }
        
        // Document Functions
        async function uploadDocument() {
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('documentStatus', '请选择文件', 'error');
                return;
            }
            
            if (!currentSpaceId) {
                showStatus('documentStatus', '请先选择空间', 'error');
                return;
            }
            
            log(`正在上传文件: ${file.name}`, 'info');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('space_id', currentSpaceId);
            
            try {
                const response = await makeRequest('POST', '/documents/upload', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                
                log(`文件上传成功! ID: ${response.data.id}`, 'success');
                showStatus('documentStatus', '文件上传成功!', 'success');
                
                // Clear file input
                fileInput.value = '';
            } catch (error) {
                log(`上传失败: ${error.response?.data?.detail || error.message}`, 'error');
                showStatus('documentStatus', `上传失败: ${error.response?.data?.detail}`, 'error');
            }
        }
        
        async function searchDocuments() {
            const query = document.getElementById('searchQuery').value;
            
            if (!query) {
                showStatus('documentStatus', '请输入搜索关键词', 'error');
                return;
            }
            
            log(`搜索文档: ${query}`, 'info');
            
            try {
                const response = await makeRequest('POST', '/documents/search', {
                    query,
                    space_id: currentSpaceId || undefined
                });
                
                const results = response.data.results;
                log(`找到 ${results.length} 个文档`, 'success');
                
                // Display results
                if (results.length > 0) {
                    const resultText = results.map(r => 
                        `- ${r.title || r.filename} (相关度: ${r.score.toFixed(2)})`
                    ).join('\n');
                    showStatus('documentStatus', `找到 ${results.length} 个结果:\n${resultText}`, 'info');
                } else {
                    showStatus('documentStatus', '未找到相关文档', 'warning');
                }
            } catch (error) {
                log(`搜索失败: ${error.response?.data?.detail || error.message}`, 'error');
                showStatus('documentStatus', `搜索失败: ${error.response?.data?.detail}`, 'error');
            }
        }
        
        // Chat Functions
        async function sendChat() {
            const message = document.getElementById('chatMessage').value;
            const model = document.getElementById('aiModel').value;
            const enableSearch = document.getElementById('enableSearch').checked;
            
            if (!message) {
                log('请输入消息内容', 'error');
                return;
            }
            
            log(`发送消息到 ${model}: ${message.substring(0, 50)}...`, 'info');
            
            // Show response area
            document.getElementById('chatResponse').style.display = 'block';
            document.getElementById('chatResponseBody').innerHTML = '<div class="spinner"></div>';
            
            const startTime = Date.now();
            
            try {
                const response = await makeRequest('POST', '/chat/completions', {
                    messages: [{ role: 'user', content: message }],
                    model,
                    search_enabled: enableSearch,
                    space_id: currentSpaceId || undefined
                });
                
                const responseTime = Date.now() - startTime;
                document.getElementById('chatResponseTime').textContent = `${responseTime}ms`;
                
                const content = response.data.choices[0].message.content;
                document.getElementById('chatResponseBody').innerHTML = `<div class="json-viewer">${content}</div>`;
                
                log(`收到AI响应 (${responseTime}ms)`, 'success');
            } catch (error) {
                log(`对话失败: ${error.response?.data?.detail || error.message}`, 'error');
                document.getElementById('chatResponseBody').innerHTML = 
                    `<div class="status status-error">错误: ${error.response?.data?.detail || error.message}</div>`;
            }
        }
        
        async function sendStreamChat() {
            const message = document.getElementById('chatMessage').value;
            const model = document.getElementById('aiModel').value;
            const enableSearch = document.getElementById('enableSearch').checked;
            
            if (!message) {
                log('请输入消息内容', 'error');
                return;
            }
            
            log(`发送流式消息到 ${model}`, 'info');
            
            // Show response area
            document.getElementById('chatResponse').style.display = 'block';
            const responseBody = document.getElementById('chatResponseBody');
            responseBody.innerHTML = '';
            
            const startTime = Date.now();
            
            try {
                const response = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: message }],
                        model,
                        search_enabled: enableSearch,
                        space_id: currentSpaceId || undefined
                    })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.content) {
                                    content += data.content;
                                    responseBody.innerHTML = `<div class="json-viewer">${content}</div>`;
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }
                
                const responseTime = Date.now() - startTime;
                document.getElementById('chatResponseTime').textContent = `${responseTime}ms`;
                log(`流式响应完成 (${responseTime}ms)`, 'success');
            } catch (error) {
                log(`流式对话失败: ${error.message}`, 'error');
                responseBody.innerHTML = 
                    `<div class="status status-error">错误: ${error.message}</div>`;
            }
        }
        
        // Custom Request
        async function sendCustomRequest() {
            const method = document.getElementById('requestMethod').value;
            const url = document.getElementById('requestUrl').value;
            const headersText = document.getElementById('requestHeaders').value;
            const bodyText = document.getElementById('requestBody').value;
            
            let headers = {};
            let body = null;
            
            try {
                if (headersText) {
                    headers = JSON.parse(headersText);
                }
                if (bodyText && method !== 'GET') {
                    body = JSON.parse(bodyText);
                }
            } catch (error) {
                log('请求头或请求体JSON格式错误', 'error');
                return;
            }
            
            log(`发送 ${method} 请求到 ${url}`, 'info');
            
            try {
                const response = await makeRequest(method, url, body, { headers });
                
                document.getElementById('responseStatus').textContent = response.status;
                document.getElementById('responseStatus').className = 
                    response.status < 400 ? 'response-status ok' : 'response-status error';
                document.getElementById('responseTime').textContent = `${response.responseTime}ms`;
                
                const responseBody = document.getElementById('responseBody');
                responseBody.textContent = JSON.stringify(response.data, null, 2);
                Prism.highlightElement(responseBody);
                
                log(`请求成功: ${response.status}`, 'success');
            } catch (error) {
                document.getElementById('responseStatus').textContent = error.response?.status || 'Error';
                document.getElementById('responseStatus').className = 'response-status error';
                document.getElementById('responseBody').textContent = 
                    JSON.stringify(error.response?.data || { error: error.message }, null, 2);
                
                log(`请求失败: ${error.response?.status} ${error.message}`, 'error');
            }
        }
        
        // Quick Tests
        async function runQuickTest() {
            log('开始快速测试...', 'info');
            
            // 首先检查是否已登录
            if (!document.getElementById('accessToken').value) {
                log('⚠️ 请先登录后再运行测试', 'warning');
                // 尝试使用演示账号自动登录
                document.getElementById('username').value = 'demo_user';
                document.getElementById('password').value = 'Demo123456!';
                await login();
                if (!document.getElementById('accessToken').value) {
                    log('❌ 自动登录失败，请手动登录', 'error');
                    return;
                }
            }
            
            // Test sequence
            const tests = [
                { name: '健康检查', fn: () => makeRequest('GET', '/health') },
                { name: '用户信息', fn: () => makeRequest('GET', '/users/me') },
                { name: '获取空间', fn: () => makeRequest('GET', '/spaces') },
                { name: '获取文档', fn: () => makeRequest('GET', '/documents') },
                { name: '获取对话', fn: () => makeRequest('GET', '/chat/conversations') },
                { name: '获取代理', fn: () => makeRequest('GET', '/agents') }
            ];
            
            let passed = 0;
            let failed = 0;
            
            for (const test of tests) {
                try {
                    const response = await test.fn();
                    if (response && response.status >= 200 && response.status < 300) {
                        log(`✅ ${test.name} - 通过`, 'success');
                        passed++;
                    } else {
                        log(`❌ ${test.name} - 失败: 状态码 ${response?.status}`, 'error');
                        failed++;
                    }
                } catch (error) {
                    log(`❌ ${test.name} - 失败: ${error.message || error}`, 'error');
                    failed++;
                }
                // 添加小延迟避免请求过快
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            log(`快速测试完成: ${passed} 通过, ${failed} 失败`, 'info');
            
            // 更新统计图表
            updateCharts();
        }
        
        async function runFullTest() {
            log('完整测试功能开发中...', 'warning');
        }
        
        async function testPerformance() {
            log('性能测试功能开发中...', 'warning');
        }
        
        // Utility Functions
        async function makeRequest(method, url, data = null, config = {}) {
            const startTime = Date.now();
            const fullUrl = url.startsWith('http') ? url : `${API_BASE}${url}`;
            
            try {
                const response = await axios({
                    method,
                    url: fullUrl,
                    data,
                    ...config
                });
                
                const responseTime = Date.now() - startTime;
                
                // Update stats
                updateRequestStats(method, response.status, responseTime);
                
                // Add to history
                addToHistory(method, url, response.status, responseTime);
                
                return { ...response, responseTime };
            } catch (error) {
                const responseTime = Date.now() - startTime;
                const status = error.response?.status || 0;
                
                // Update stats
                updateRequestStats(method, status, responseTime);
                
                // Add to history
                addToHistory(method, url, status, responseTime);
                
                throw error;
            }
        }
        
        function updateRequestStats(method, status, responseTime) {
            stats.totalRequests++;
            stats.totalResponseTime += responseTime;
            
            if (status >= 200 && status < 300) {
                stats.successCount++;
            } else {
                stats.errorCount++;
            }
            
            // Method counts
            stats.methodCounts[method] = (stats.methodCounts[method] || 0) + 1;
            
            // Status counts
            const statusGroup = Math.floor(status / 100) + 'xx';
            stats.statusCounts[statusGroup] = (stats.statusCounts[statusGroup] || 0) + 1;
            
            // Response times for chart
            stats.responseTimes.push({
                time: new Date().toLocaleTimeString(),
                value: responseTime
            });
            
            // Keep last 50 response times
            if (stats.responseTimes.length > 50) {
                stats.responseTimes.shift();
            }
            
            updateStats();
        }
        
        function updateStats() {
            // Header stats
            document.getElementById('totalRequests').textContent = stats.totalRequests;
            document.getElementById('successRate').textContent = 
                stats.totalRequests > 0 
                    ? Math.round(stats.successCount / stats.totalRequests * 100) + '%'
                    : '0%';
            document.getElementById('avgResponseTime').textContent = 
                stats.totalRequests > 0
                    ? Math.round(stats.totalResponseTime / stats.totalRequests) + 'ms'
                    : '0ms';
            
            // Monitor stats
            document.getElementById('monitorTotalRequests').textContent = stats.totalRequests;
            document.getElementById('monitorSuccessRate').textContent = 
                stats.totalRequests > 0 
                    ? Math.round(stats.successCount / stats.totalRequests * 100) + '%'
                    : '0%';
            document.getElementById('monitorAvgTime').textContent = 
                stats.totalRequests > 0
                    ? Math.round(stats.totalResponseTime / stats.totalRequests) + 'ms'
                    : '0ms';
            document.getElementById('monitorErrors').textContent = stats.errorCount;
        }
        
        function updateCharts() {
            // Response Time Chart
            if (responseTimeChart) {
                responseTimeChart.data.labels = stats.responseTimes.map(rt => rt.time);
                responseTimeChart.data.datasets[0].data = stats.responseTimes.map(rt => rt.value);
                responseTimeChart.update();
            }
            
            // Method Chart
            if (methodChart) {
                const methods = ['GET', 'POST', 'PUT', 'DELETE'];
                methodChart.data.datasets[0].data = methods.map(m => stats.methodCounts[m] || 0);
                methodChart.update();
            }
            
            // Status Chart
            if (statusChart) {
                const statuses = ['2xx', '3xx', '4xx', '5xx'];
                statusChart.data.datasets[0].data = statuses.map(s => stats.statusCounts[s] || 0);
                statusChart.update();
            }
        }
        
        function addToHistory(method, url, status, responseTime) {
            const historyItem = {
                method,
                url,
                status,
                responseTime,
                timestamp: new Date().toISOString()
            };
            
            requestHistory.unshift(historyItem);
            
            // Keep last 100 items
            if (requestHistory.length > 100) {
                requestHistory.pop();
            }
            
            localStorage.setItem('sb_history', JSON.stringify(requestHistory));
            
            // Update display if on history tab
            if (document.getElementById('history-tab').classList.contains('active')) {
                displayHistory();
            }
        }
        
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            const searchTerm = document.getElementById('historySearch')?.value.toLowerCase() || '';
            
            historyList.innerHTML = '';
            
            requestHistory
                .filter(item => 
                    !searchTerm || 
                    item.url.toLowerCase().includes(searchTerm) ||
                    item.method.toLowerCase().includes(searchTerm)
                )
                .forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <div>
                            <span class="history-method ${item.method}">${item.method}</span>
                            <span class="history-url">${item.url}</span>
                        </div>
                        <div>
                            <span class="history-status ${item.status < 400 ? 'success' : 'error'}">${item.status}</span>
                            <span class="history-time">${item.responseTime}ms</span>
                        </div>
                    `;
                    div.onclick = () => {
                        // Fill custom request form
                        document.getElementById('requestMethod').value = item.method;
                        document.getElementById('requestUrl').value = item.url;
                        switchTab('advanced');
                    };
                    historyList.appendChild(div);
                });
        }
        
        function clearHistory() {
            if (confirm('确定要清空请求历史吗？')) {
                requestHistory = [];
                localStorage.removeItem('sb_history');
                displayHistory();
                log('请求历史已清空', 'info');
            }
        }
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.className = `status status-${type}`;
            element.textContent = message;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
        
        function exportResults() {
            const exportData = {
                timestamp: new Date().toISOString(),
                stats,
                history: requestHistory
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `secondbrain-api-test-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('测试结果已导出', 'success');
        }
        
        function showAPIDoc() {
            window.open(`${BASE_URL}/api/v1/docs`, '_blank');
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        // Search functionality
        document.getElementById('historySearch')?.addEventListener('input', displayHistory);
    </script>
</body>
</html>