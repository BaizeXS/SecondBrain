# Second Brain 后端架构

## 概述

Second Brain 后端采用三层架构设计，实现了清晰的职责分离和良好的可维护性。

## 架构层次

### 1. API 层 (Endpoints)

- **位置**: `app/api/v1/endpoints/`
- **职责**:
  - 处理 HTTP 请求和响应
  - 参数验证
  - 权限检查
  - 错误处理
  - 返回标准化响应

### 2. 服务层 (Services)

- **位置**: `app/services/`
- **职责**:
  - 业务逻辑实现
  - 跨实体操作
  - 事务管理
  - 第三方服务集成

### 3. 数据访问层 (CRUD)

- **位置**: `app/crud/`
- **职责**:
  - 数据库 CRUD 操作
  - 查询构建
  - 数据库事务
  - 基础数据验证

## 请求流程

```
Client Request
    ↓
API Endpoint (验证、权限)
    ↓
Service Layer (业务逻辑)
    ↓
CRUD Layer (数据访问)
    ↓
Database
```

## 核心模块

### 认证模块

- JWT 令牌认证
- 用户权限管理
- API 访问控制

### 空间管理

- 知识空间的创建和管理
- 协作权限控制
- 空间统计信息

### 文档管理

- 文档上传和存储
- 内容提取和搜索
- 版本控制

### 对话系统

- AI 聊天功能
- 对话历史管理
- 多模型支持

### AI 服务

- 支持多个 AI 提供商（OpenAI、Anthropic、Google、DeepSeek）
- 智能模型选择
- 流式响应支持

## 技术栈

- **框架**: FastAPI
- **数据库**: PostgreSQL (异步)
- **ORM**: SQLAlchemy 2.0
- **缓存**: Redis
- **对象存储**: MinIO
- **向量数据库**: Qdrant
- **认证**: JWT
- **异步**: Python asyncio

## 配置管理

- 使用 Pydantic Settings 管理配置
- 支持环境变量
- 分离开发和生产配置

## 服务智能选择

系统会根据配置自动选择使用完整版或简化版服务：

- AI 服务：有 API 密钥时使用完整版，否则使用模拟响应
- 文档服务：统一使用带 CRUD 层的版本

## 错误处理

- 统一的异常处理中间件
- 标准化的错误响应格式
- 详细的错误日志记录

## 扩展性

- 模块化设计，易于添加新功能
- 清晰的接口定义
- 支持插件式开发
