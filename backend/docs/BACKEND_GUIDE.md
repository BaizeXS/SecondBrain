# Second Brain 后端架构指南

## 一、整体架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端（前端）                         │
│                   (Web浏览器/移动App等)                      │
└─────────────────────────────────────────────────────────────┘
                                ↓ HTTP/HTTPS
┌─────────────────────────────────────────────────────────────┐
│                      API 网关层 (FastAPI)                    │
│                         端口: 8000                           │
│                    app/main.py (入口文件)                    │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                        路由层 (Routes)                       │
│                    app/api/v1/endpoints/                     │
│    ┌─────────┬──────────┬──────────┬──────────┬────────┐   │
│    │  auth   │  spaces  │documents │  chat    │ agents │   │
│    └─────────┴──────────┴──────────┴──────────┴────────┘   │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                       服务层 (Services)                      │
│                      app/services/                           │
│    ┌────────────┬────────────┬────────────┬────────────┐   │
│    │ AIService  │DocService  │SpaceService│AgentService│   │
│    └────────────┴────────────┴────────────┴────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                    数据访问层 (CRUD/ORM)                     │
│                        app/crud/                             │
│    ┌──────────┬──────────┬──────────┬──────────────────┐   │
│    │ UserCRUD │SpaceCRUD │ DocCRUD  │ConversationCRUD │   │
│    └──────────┴──────────┴──────────┴──────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据模型层 (Models)                     │
│                      app/models/models.py                    │
│    ┌──────────┬──────────┬──────────┬──────────────────┐   │
│    │   User   │  Space   │ Document │  Conversation   │   │
│    └──────────┴──────────┴──────────┴──────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                        外部服务层                            │
│  ┌────────────┬────────────┬────────────┬────────────────┐ │
│  │PostgreSQL  │   Redis    │   MinIO    │    Qdrant      │ │
│  │ (主数据库) │  (缓存)    │ (文件存储) │  (向量数据库)  │ │
│  └────────────┴────────────┴────────────┴────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 二、核心概念解释

### 1. 什么是后端？
后端是应用程序中处理业务逻辑、数据存储、安全认证等核心功能的部分。它接收前端的请求，处理后返回结果。

### 2. 请求的生命周期
```
用户操作 → 前端发送请求 → 后端接收 → 验证身份 → 处理业务 → 访问数据库 → 返回结果
```

### 3. 分层架构的好处
- **解耦合**：每层只关注自己的职责
- **可维护**：修改某一层不影响其他层
- **可测试**：每层可以独立测试
- **可扩展**：容易添加新功能

## 三、各层详细说明

### 1. API层 (app/main.py + app/api/)
**作用**：接收HTTP请求，返回HTTP响应
```python
# 例子：接收登录请求
POST /api/v1/auth/login
{
    "username": "user",
    "password": "pass"
}
```

### 2. 路由层 (app/api/v1/endpoints/)
**作用**：将不同的URL路径分配给对应的处理函数
- `/auth/*` → 处理认证相关
- `/spaces/*` → 处理空间管理
- `/documents/*` → 处理文档操作

### 3. 服务层 (app/services/)
**作用**：实现具体的业务逻辑
- 验证业务规则
- 协调多个数据操作
- 调用外部API（如OpenAI）

### 4. 数据访问层 (app/crud/)
**作用**：封装数据库操作
- 创建（Create）
- 读取（Read）
- 更新（Update）
- 删除（Delete）

### 5. 模型层 (app/models/)
**作用**：定义数据结构
- 数据库表结构
- 字段类型和约束
- 表之间的关系

### 6. 模式层 (app/schemas/)
**作用**：定义数据验证规则
- 请求数据格式
- 响应数据格式
- 数据类型检查

## 四、关键技术点

### 1. FastAPI
- **异步处理**：可同时处理多个请求
- **自动文档**：访问 `/docs` 查看API文档
- **类型检查**：自动验证数据格式

### 2. SQLAlchemy (ORM)
- **对象关系映射**：用Python类表示数据库表
- **自动SQL**：不用手写SQL语句
- **数据库无关**：可切换不同数据库

### 3. Pydantic
- **数据验证**：自动检查数据格式
- **序列化**：Python对象↔JSON转换
- **IDE支持**：代码提示和自动完成

### 4. JWT认证
- **无状态**：服务器不保存会话
- **安全**：令牌包含用户信息
- **分布式友好**：适合微服务架构

## 五、常见操作流程

### 1. 用户注册流程
```
1. 前端发送注册信息
2. 路由层接收请求 (auth.py)
3. 验证数据格式 (schemas/users.py)
4. 服务层处理业务逻辑
   - 检查用户名是否存在
   - 密码加密
5. CRUD层保存到数据库
6. 返回成功响应
```

### 2. 文档上传流程
```
1. 前端上传文件
2. 路由层接收文件 (documents.py)
3. 服务层处理
   - 保存文件到MinIO
   - 提取文本内容
   - 生成向量嵌入
4. 保存元数据到PostgreSQL
5. 保存向量到Qdrant
6. 返回文档信息
```

## 六、数据流示例

### 创建一个新空间
```python
# 1. 请求到达路由
POST /api/v1/spaces
Authorization: Bearer <token>
{
    "name": "我的笔记",
    "description": "个人学习笔记"
}

# 2. 路由调用服务
space = await space_service.create_space(data, user_id)

# 3. 服务调用CRUD
new_space = await crud.space.create(db, obj_in=data, user_id=user_id)

# 4. CRUD操作数据库
INSERT INTO spaces (name, description, user_id) VALUES (...)

# 5. 返回结果
{
    "id": 1,
    "name": "我的笔记",
    "description": "个人学习笔记",
    "created_at": "2024-01-01T00:00:00"
}
```

## 七、开发建议

### 初学者学习路径
1. **理解HTTP基础**：GET/POST/PUT/DELETE
2. **学习路由概念**：URL如何映射到函数
3. **掌握CRUD操作**：基本的数据操作
4. **理解异步编程**：async/await
5. **实践API设计**：RESTful原则

### 调试技巧
1. **查看日志**：`tail -f uvicorn.log`
2. **使用文档**：访问 `http://localhost:8000/docs`
3. **断点调试**：在代码中加入 `print()` 或 `logger.info()`
4. **测试API**：使用 Postman 或 curl

### 常见问题
1. **端口被占用**：检查并关闭占用端口的程序
2. **数据库连接失败**：确保 Docker 服务正在运行
3. **导入错误**：检查文件路径和模块名称
4. **认证失败**：检查 JWT 令牌是否正确

## 八、下一步

建议按以下顺序深入学习：
1. **路由和请求处理**（最直观）
2. **数据模型和CRUD**（核心基础）
3. **认证和授权**（安全相关）
4. **服务层业务逻辑**（复杂功能）
5. **外部服务集成**（高级功能）

---

这是一个渐进式的学习指南，你可以根据自己的兴趣和需求，选择相应的部分深入学习。有任何疑问都可以随时问我！