# Second Brain æŠ€æœ¯æ–‡æ¡£ä¸æ¶æ„è®¾è®¡

## ä¸€ã€ç³»ç»ŸåŠŸèƒ½æ ‘

```
Second Brain
â”œâ”€â”€ ğŸ  ä¸»é¡µæ¨¡å— (Home)
â”‚   â”œâ”€â”€ æ ¸å¿ƒç•Œé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ä¸­å¤®è¾“å…¥æ¡†
â”‚   â”‚   â”œâ”€â”€ å¿«é€Ÿå¯åŠ¨å»ºè®®
â”‚   â”‚   â””â”€â”€ ä¸‰æ å¸ƒå±€ç®¡ç†
â”‚   â”œâ”€â”€ å·¥å…·æ æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ Chatæ¨¡å¼ï¼ˆçº¯AIå¯¹è¯ï¼‰
â”‚   â”‚   â”œâ”€â”€ Searchæ¨¡å¼ï¼ˆæ™ºèƒ½æœç´¢ï¼‰
â”‚   â”‚   â””â”€â”€ Thinkæ¨¡å¼ï¼ˆæ·±åº¦æ¨ç†ï¼‰
â”‚   â””â”€â”€ è®¾ç½®åŒºæ¨¡å—
â”‚       â”œâ”€â”€ æ¨¡å‹é€‰æ‹©å™¨
â”‚       â”œâ”€â”€ æ–‡ä»¶ä¸Šä¼ 
â”‚       â””â”€â”€ æœç´¢èŒƒå›´é…ç½®
â”‚
â”œâ”€â”€ ğŸ¤– AIä»£ç†ç³»ç»Ÿ (AI Agents)
â”‚   â”œâ”€â”€ å†…ç½®ä»£ç†
â”‚   â”‚   â”œâ”€â”€ Deep Research Agent
â”‚   â”‚   â”œâ”€â”€ Wiki Generator Agent
â”‚   â”‚   â””â”€â”€ Data Analysis Agent
â”‚   â”œâ”€â”€ ä»£ç†ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ è‡ªå®šä¹‰ä»£ç†åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ ä»£ç†å¸‚åœº
â”‚   â”‚   â””â”€â”€ ä»£ç†ç¼–æ’å·¥ä½œæµ
â”‚   â””â”€â”€ ä»£ç†æ‰§è¡Œå¼•æ“
â”‚
â”œâ”€â”€ ğŸ“š çŸ¥è¯†åº“ç®¡ç† (Knowledge Base)
â”‚   â”œâ”€â”€ Spaceç®¡ç†
â”‚   â”‚   â”œâ”€â”€ Spaceåˆ›å»º/ç¼–è¾‘/åˆ é™¤
â”‚   â”‚   â”œâ”€â”€ Spaceå…ƒæ•°æ®ç®¡ç†
â”‚   â”‚   â””â”€â”€ Spaceæƒé™æ§åˆ¶
â”‚   â”œâ”€â”€ èµ„æºç®¡ç†
â”‚   â”‚   â”œâ”€â”€ æ–‡æ¡£å¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ æ–‡æ¡£ä¸Šä¼ /è§£æ
â”‚   â”‚   â”‚   â”œâ”€â”€ æ–‡æ¡£é¢„è§ˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ æ–‡æ¡£æ ‡æ³¨
â”‚   â”‚   â”‚   â””â”€â”€ æ–‡æ¡£ç¿»è¯‘
â”‚   â”‚   â”œâ”€â”€ ç½‘é¡µå†…å®¹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ å¤šåª’ä½“ç®¡ç†
â”‚   â”‚   â””â”€â”€ ç¬”è®°ç³»ç»Ÿ
â”‚   â”œâ”€â”€ çŸ¥è¯†å›¾è°±
â”‚   â”‚   â”œâ”€â”€ å®ä½“è¯†åˆ«
â”‚   â”‚   â”œâ”€â”€ å…³ç³»æŠ½å–
â”‚   â”‚   â””â”€â”€ å›¾è°±å¯è§†åŒ–
â”‚   â””â”€â”€ å¯¹è¯å†å²ç®¡ç†
â”‚
â”œâ”€â”€ ğŸ‘¥ åä½œç³»ç»Ÿ (Collaboration)
â”‚   â”œâ”€â”€ å…±äº«ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ Spaceå…±äº«
â”‚   â”‚   â”œâ”€â”€ æƒé™æ§åˆ¶
â”‚   â”‚   â””â”€â”€ åä½œç¼–è¾‘
â”‚   â”œâ”€â”€ å›¢é˜ŸåŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ å›¢é˜ŸSpace
â”‚   â”‚   â”œâ”€â”€ è®¨è®ºåŠŸèƒ½
â”‚   â”‚   â””â”€â”€ å·¥ä½œæµç®¡ç†
â”‚   â””â”€â”€ å˜æ›´è¿½è¸ª
â”‚
â”œâ”€â”€ ğŸ‘¤ ç”¨æˆ·ç³»ç»Ÿ (User Management)
â”‚   â”œâ”€â”€ è®¤è¯æˆæƒ
â”‚   â”‚   â”œâ”€â”€ ç”¨æˆ·æ³¨å†Œ/ç™»å½•
â”‚   â”‚   â”œâ”€â”€ OAuthé›†æˆ
â”‚   â”‚   â””â”€â”€ JWTä»¤ç‰Œç®¡ç†
â”‚   â”œâ”€â”€ æƒé™ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ å…è´¹ç”¨æˆ·é™åˆ¶
â”‚   â”‚   â”œâ”€â”€ ä¼šå‘˜æƒé™
â”‚   â”‚   â””â”€â”€ APIé…é¢ç®¡ç†
â”‚   â””â”€â”€ ç”¨æˆ·é…ç½®
â”‚       â”œâ”€â”€ API Keyç®¡ç†
â”‚       â”œâ”€â”€ ä¸ªæ€§åŒ–è®¾ç½®
â”‚       â””â”€â”€ ä½¿ç”¨ç»Ÿè®¡
â”‚
â””â”€â”€ âš™ï¸ ç³»ç»Ÿè®¾ç½® (System Settings)
    â”œâ”€â”€ æ¨¡å‹é…ç½®
    â”‚   â”œâ”€â”€ æ¨¡å‹ç®¡ç†
    â”‚   â”œâ”€â”€ APIé…ç½®
    â”‚   â””â”€â”€ æˆæœ¬æ§åˆ¶
    â”œâ”€â”€ æ•°æ®ç®¡ç†
    â”‚   â”œâ”€â”€ å¯¼å…¥å¯¼å‡º
    â”‚   â”œâ”€â”€ å¤‡ä»½æ¢å¤
    â”‚   â””â”€â”€ æ•°æ®å®‰å…¨
    â””â”€â”€ ç³»ç»Ÿç›‘æ§
        â”œâ”€â”€ æ€§èƒ½ç›‘æ§
        â”œâ”€â”€ æ—¥å¿—ç®¡ç†
        â””â”€â”€ é”™è¯¯è¿½è¸ª
```

## äºŒã€æŠ€æœ¯æ¶æ„è®¾è®¡

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯åº”ç”¨å±‚                              â”‚
â”‚  (React/Vue + TypeScript + TailwindCSS + WebSocket)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APIç½‘å…³å±‚                                â”‚
â”‚              (Nginx + Rate Limiting + CORS)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI åç«¯æœåŠ¡å±‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   è®¤è¯    â”‚   AIæœåŠ¡  â”‚  çŸ¥è¯†åº“   â”‚   åä½œ    â”‚  ç³»ç»Ÿç®¡ç† â”‚  â”‚
â”‚  â”‚  æœåŠ¡     â”‚   æ¨¡å—    â”‚   æœåŠ¡    â”‚   æœåŠ¡    â”‚   æœåŠ¡   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å­˜å‚¨å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚PostgreSQLâ”‚Redis  â”‚MinIO  â”‚Qdrant â”‚Elastic â”‚Kafka   â”‚   â”‚
â”‚  â”‚(ä¸»æ•°æ®åº“)â”‚(ç¼“å­˜) â”‚(æ–‡ä»¶) â”‚(å‘é‡) â”‚(æœç´¢) â”‚(æ¶ˆæ¯)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¤–éƒ¨æœåŠ¡é›†æˆ                             â”‚
â”‚   OpenAI â”‚ Anthropic â”‚ Gemini â”‚ DeepSeek â”‚ Perplexity       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆé€‰æ‹©

### åç«¯æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: FastAPI (å¼‚æ­¥æ”¯æŒã€è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ)

- **å¼‚æ­¥è¿è¡Œæ—¶**: Uvicorn + Gunicorn

- **æ•°æ®åº“**:
  - PostgreSQL (ä¸»æ•°æ®å­˜å‚¨)
  - Redis (ç¼“å­˜ã€ä¼šè¯ã€é™æµ)
  - MinIO (æ–‡ä»¶å¯¹è±¡å­˜å‚¨)
  - Qdrant (å‘é‡æ•°æ®åº“)
  - Elasticsearch (å…¨æ–‡æœç´¢)
  
- **æ¶ˆæ¯é˜Ÿåˆ—**: Kafka/RabbitMQ (å¼‚æ­¥ä»»åŠ¡)

- **ä»»åŠ¡è°ƒåº¦**: Celery + Celery Beat

- **è®¤è¯**: JWT + OAuth2

- **APIæ–‡æ¡£**: OpenAPI/Swagger

### ä¾èµ–åº“

- **ORM**: SQLAlchemy 2.0 (å¼‚æ­¥æ”¯æŒ)

- **æ•°æ®éªŒè¯**: Pydantic V2

- **HTTPå®¢æˆ·ç«¯**: httpx (å¼‚æ­¥)

- **æ–‡æ¡£å¤„ç†**:
  - PyPDF2/pdfplumber (PDF)
  - python-docx (Word)
  - python-pptx (PowerPoint)
  - markdown2 (Markdown)
  
- **NLPå¤„ç†**:
- LangChain (AIç¼–æ’)
  - spaCy (å®ä½“è¯†åˆ«)
- transformers (åµŒå…¥)

## ä¸‰ã€åç«¯APIè®¾è®¡

### 3.1 APIè·¯ç”±ç»“æ„

```python
# APIè·¯ç”±ç»“æ„
api/
â”œâ”€â”€ v1/
â”‚   â”œâ”€â”€ auth/          # è®¤è¯ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ register
â”‚   â”‚   â”œâ”€â”€ login
â”‚   â”‚   â”œâ”€â”€ refresh
â”‚   â”‚   â””â”€â”€ logout
â”‚   â”‚
â”‚   â”œâ”€â”€ chat/          # èŠå¤©åŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ conversations
â”‚   â”‚   â”œâ”€â”€ messages
â”‚   â”‚   â””â”€â”€ stream
â”‚   â”‚
â”‚   â”œâ”€â”€ search/        # æœç´¢åŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ web
â”‚   â”‚   â”œâ”€â”€ academic
â”‚   â”‚   â””â”€â”€ news
â”‚   â”‚
â”‚   â”œâ”€â”€ think/         # æ¨ç†åŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ analyze
â”‚   â”‚   â””â”€â”€ reasoning
â”‚   â”‚
â”‚   â”œâ”€â”€ agents/        # AIä»£ç†
â”‚   â”‚   â”œâ”€â”€ list
â”‚   â”‚   â”œâ”€â”€ create
â”‚   â”‚   â”œâ”€â”€ execute
â”‚   â”‚   â””â”€â”€ workflows
â”‚   â”‚
â”‚   â”œâ”€â”€ spaces/        # çŸ¥è¯†ç©ºé—´
â”‚   â”‚   â”œâ”€â”€ CRUDæ“ä½œ
â”‚   â”‚   â”œâ”€â”€ resources/
â”‚   â”‚   â”œâ”€â”€ knowledge-graph/
â”‚   â”‚   â””â”€â”€ analytics/
â”‚   â”‚
â”‚   â”œâ”€â”€ documents/     # æ–‡æ¡£ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ upload
â”‚   â”‚   â”œâ”€â”€ preview
â”‚   â”‚   â”œâ”€â”€ annotate
â”‚   â”‚   â””â”€â”€ translate
â”‚   â”‚
â”‚   â”œâ”€â”€ collaboration/ # åä½œåŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ share
â”‚   â”‚   â”œâ”€â”€ permissions
â”‚   â”‚   â””â”€â”€ activities
â”‚   â”‚
â”‚   â””â”€â”€ settings/      # ç³»ç»Ÿè®¾ç½®
â”‚       â”œâ”€â”€ profile
â”‚       â”œâ”€â”€ api-keys
â”‚       â””â”€â”€ preferences
```

### 3.2 æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.2.1 è®¤è¯æˆæƒæ¨¡å—

```python
# app/core/auth.py
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt
from datetime import datetime, timedelta
from typing import Optional

class AuthService:
    def __init__(self):
        self.oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")
        self.SECRET_KEY = settings.SECRET_KEY
        self.ALGORITHM = "HS256"
        self.ACCESS_TOKEN_EXPIRE_MINUTES = 30

    def create_access_token(self, data: dict, expires_delta: Optional[timedelta] = None):
        to_encode = data.copy()
        if expires_delta:
            expire = datetime.utcnow() + expires_delta
        else:
            expire = datetime.utcnow() + timedelta(minutes=15)
        to_encode.update({"exp": expire})
        encoded_jwt = jwt.encode(to_encode, self.SECRET_KEY, algorithm=self.ALGORITHM)
        return encoded_jwt

    async def get_current_user(self, token: str = Depends(oauth2_scheme)):
        credentials_exception = HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Could not validate credentials",
            headers={"WWW-Authenticate": "Bearer"},
        )
        try:
            payload = jwt.decode(token, self.SECRET_KEY, algorithms=[self.ALGORITHM])
            username: str = payload.get("sub")
            if username is None:
                raise credentials_exception
            token_data = TokenData(username=username)
        except JWTError:
            raise credentials_exception
        user = await get_user(username=token_data.username)
        if user is None:
            raise credentials_exception
        return user
```

### 3.2.2 AIæœåŠ¡æ¨¡å—

```python
# app/services/ai_service.py
from abc import ABC, abstractmethod
from typing import AsyncGenerator, Dict, Any
import httpx
from langchain.chat_models import ChatOpenAI, ChatAnthropic
from langchain.callbacks.streaming_stdout import StreamingStdOutCallbackHandler

class AIProvider(ABC):
    @abstractmethod
    async def chat(self, messages: List[Dict], **kwargs) -> str:
        pass

    @abstractmethod
    async def stream_chat(self, messages: List[Dict], **kwargs) -> AsyncGenerator:
        pass

class OpenAIProvider(AIProvider):
    def __init__(self, api_key: str):
        self.client = ChatOpenAI(
            api_key=api_key,
            streaming=True,
            callbacks=[StreamingStdOutCallbackHandler()]
        )

    async def chat(self, messages: List[Dict], **kwargs) -> str:
        response = await self.client.achat(messages, **kwargs)
        return response.content

    async def stream_chat(self, messages: List[Dict], **kwargs) -> AsyncGenerator:
        async for chunk in self.client.astream(messages, **kwargs):
            yield chunk.content

class AIService:
    def __init__(self):
        self.providers = {
            "openai": OpenAIProvider,
            "anthropic": AnthropicProvider,
            "gemini": GeminiProvider,
            "deepseek": DeepSeekProvider
        }

    async def get_provider(self, provider_name: str, api_key: str) -> AIProvider:
        provider_class = self.providers.get(provider_name)
        if not provider_class:
            raise ValueError(f"Unknown provider: {provider_name}")
        return provider_class(api_key)

    async def route_request(self, request: ChatRequest, user: User) -> ChatResponse:
        # æ™ºèƒ½è·¯ç”±é€»è¾‘
        if request.mode == "auto":
            provider_name, model = await self.auto_select_model(request)
        else:
            provider_name, model = request.provider, request.model

        provider = await self.get_provider(provider_name, user.get_api_key(provider_name))

        if request.stream:
            return StreamingResponse(
                provider.stream_chat(request.messages, model=model),
                media_type="text/event-stream"
            )
        else:
            response = await provider.chat(request.messages, model=model)
            return ChatResponse(content=response, model=model)
```

### 3.2.3 çŸ¥è¯†åº“æœåŠ¡æ¨¡å—

```python
# app/services/knowledge_service.py
from typing import List, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from app.models import Space, Document, Note
from app.core.vector_store import VectorStore

class KnowledgeService:
    def __init__(self, db: AsyncSession, vector_store: VectorStore):
        self.db = db
        self.vector_store = vector_store

    async def create_space(self, user_id: int, space_data: SpaceCreate) -> Space:
        space = Space(
            user_id=user_id,
            name=space_data.name,
            description=space_data.description,
            metadata=space_data.metadata
        )
        self.db.add(space)
        await self.db.commit()
        await self.db.refresh(space)

        # åˆå§‹åŒ–å‘é‡å­˜å‚¨é›†åˆ
        await self.vector_store.create_collection(f"space_{space.id}")

        return space

    async def add_document_to_space(
        self,
        space_id: int,
        file: UploadFile,
        user_id: int
    ) -> Document:
        # 1. ä¿å­˜æ–‡ä»¶åˆ°å¯¹è±¡å­˜å‚¨
        file_url = await self.upload_file_to_storage(file)

        # 2. è§£ææ–‡æ¡£å†…å®¹
        content = await self.parse_document(file)

        # 3. ç”Ÿæˆå‘é‡åµŒå…¥
        embeddings = await self.generate_embeddings(content)

        # 4. ä¿å­˜åˆ°æ•°æ®åº“
        document = Document(
            space_id=space_id,
            user_id=user_id,
            filename=file.filename,
            file_url=file_url,
            content=content,
            metadata={
                "size": file.size,
                "content_type": file.content_type
            }
        )
        self.db.add(document)
        await self.db.commit()

        # 5. å­˜å‚¨å‘é‡
        await self.vector_store.add_documents(
            collection_name=f"space_{space_id}",
            documents=[{
                "id": str(document.id),
                "content": content,
                "metadata": document.metadata
            }],
            embeddings=embeddings
        )

        return document

    async def search_in_space(
        self,
        space_id: int,
        query: str,
        limit: int = 10
    ) -> List[SearchResult]:
        # 1. ç”ŸæˆæŸ¥è¯¢å‘é‡
        query_embedding = await self.generate_embedding(query)

        # 2. å‘é‡æœç´¢
        results = await self.vector_store.search(
            collection_name=f"space_{space_id}",
            query_vector=query_embedding,
            limit=limit
        )

        # 3. è·å–æ–‡æ¡£è¯¦æƒ…
        document_ids = [r["id"] for r in results]
        documents = await self.db.query(Document).filter(
            Document.id.in_(document_ids)
        ).all()

        return [
            SearchResult(
                document=doc,
                score=result["score"],
                highlight=self.extract_highlight(doc.content, query)
            )
            for doc, result in zip(documents, results)
        ]
```

### 3.2.4 æ–‡æ¡£å¤„ç†æ¨¡å—

```python
# app/services/document_service.py
import asyncio
from typing import Dict, Any
from app.core.parsers import PDFParser, DocxParser, PPTXParser

class DocumentService:
    def __init__(self):
        self.parsers = {
            'application/pdf': PDFParser(),
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': DocxParser(),
            'application/vnd.openxmlformats-officedocument.presentationml.presentation': PPTXParser(),
            'text/markdown': MarkdownParser(),
            'text/plain': TextParser()
        }

    async def parse_document(self, file: UploadFile) -> Dict[str, Any]:
        parser = self.parsers.get(file.content_type)
        if not parser:
            raise ValueError(f"Unsupported file type: {file.content_type}")

        content = await file.read()
        return await parser.parse(content)

    async def generate_preview(self, document_id: int, page: int = 1) -> bytes:
        document = await self.get_document(document_id)

        # æ ¹æ®æ–‡æ¡£ç±»å‹ç”Ÿæˆé¢„è§ˆ
        if document.content_type == 'application/pdf':
            return await self.generate_pdf_preview(document, page)
        else:
            # è½¬æ¢ä¸ºHTMLé¢„è§ˆ
            return await self.generate_html_preview(document)

    async def translate_document(
        self,
        document_id: int,
        target_language: str,
        translation_service: str = "deepseek"
    ) -> Document:
        document = await self.get_document(document_id)

        # åˆ†æ®µç¿»è¯‘
        segments = self.split_document_into_segments(document.content)
        translated_segments = []

        for segment in segments:
            translated = await self.translate_segment(
                segment,
                target_language,
                translation_service
            )
            translated_segments.append(translated)

        # ä¿å­˜ç¿»è¯‘ç»“æœ
        translated_document = Document(
            space_id=document.space_id,
            user_id=document.user_id,
            filename=f"{document.filename}_translated_{target_language}",
            content="\\n".join(translated_segments),
            parent_id=document.id,
            metadata={
                "source_language": document.metadata.get("language", "auto"),
                "target_language": target_language,
                "translation_service": translation_service
            }
        )

        self.db.add(translated_document)
        await self.db.commit()

        return translated_document
```

### 3.3 æ•°æ®åº“è®¾è®¡

```python
# app/models/models.py
from sqlalchemy import Column, Integer, String, Text, JSON, ForeignKey, DateTime, Boolean
from sqlalchemy.orm import relationship
from app.core.database import Base

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, index=True, nullable=False)
    email = Column(String(100), unique=True, index=True, nullable=False)
    hashed_password = Column(String(100), nullable=False)
    is_active = Column(Boolean, default=True)
    is_premium = Column(Boolean, default=False)
    created_at = Column(DateTime, server_default=func.now())

    # å…³ç³»
    spaces = relationship("Space", back_populates="user")
    api_keys = relationship("APIKey", back_populates="user")
    conversations = relationship("Conversation", back_populates="user")

class Space(Base):
    __tablename__ = "spaces"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    name = Column(String(200), nullable=False)
    description = Column(Text)
    metadata = Column(JSON)
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, onupdate=func.now())

    # å…³ç³»
    user = relationship("User", back_populates="spaces")
    documents = relationship("Document", back_populates="space")
    notes = relationship("Note", back_populates="space")
    conversations = relationship("Conversation", back_populates="space")

class Document(Base):
    __tablename__ = "documents"

    id = Column(Integer, primary_key=True, index=True)
    space_id = Column(Integer, ForeignKey("spaces.id"), nullable=False)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    filename = Column(String(500), nullable=False)
    file_url = Column(String(1000))
    content = Column(Text)
    content_type = Column(String(100))
    metadata = Column(JSON)
    parent_id = Column(Integer, ForeignKey("documents.id"))  # ç”¨äºç¿»è¯‘æ–‡æ¡£
    created_at = Column(DateTime, server_default=func.now())

    # å…³ç³»
    space = relationship("Space", back_populates="documents")
    annotations = relationship("Annotation", back_populates="document")
    children = relationship("Document", backref="parent", remote_side=[id])

class Conversation(Base):
    __tablename__ = "conversations"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    space_id = Column(Integer, ForeignKey("spaces.id"))
    mode = Column(String(20))  # chat, search, think
    title = Column(String(500))
    metadata = Column(JSON)
    created_at = Column(DateTime, server_default=func.now())

    # å…³ç³»
    user = relationship("User", back_populates="conversations")
    space = relationship("Space", back_populates="conversations")
    messages = relationship("Message", back_populates="conversation")

class Message(Base):
    __tablename__ = "messages"

    id = Column(Integer, primary_key=True, index=True)
    conversation_id = Column(Integer, ForeignKey("conversations.id"), nullable=False)
    role = Column(String(20))  # user, assistant, system
    content = Column(Text)
    model = Column(String(100))
    metadata = Column(JSON)  # åŒ…å«å¼•ç”¨ã€æ¥æºç­‰
    created_at = Column(DateTime, server_default=func.now())

    # å…³ç³»
    conversation = relationship("Conversation", back_populates="messages")
```

### 3.4 WebSocketå®æ—¶é€šä¿¡

```python
# app/core/websocket.py
from fastapi import WebSocket, WebSocketDisconnect
from typing import Dict, Set
import json

class ConnectionManager:
    def __init__(self):
        self.active_connections: Dict[int, Set[WebSocket]] = {}

    async def connect(self, websocket: WebSocket, user_id: int):
        await websocket.accept()
        if user_id not in self.active_connections:
            self.active_connections[user_id] = set()
        self.active_connections[user_id].add(websocket)

    def disconnect(self, websocket: WebSocket, user_id: int):
        self.active_connections[user_id].discard(websocket)
        if not self.active_connections[user_id]:
            del self.active_connections[user_id]

    async def send_personal_message(self, message: str, user_id: int):
        if user_id in self.active_connections:
            for connection in self.active_connections[user_id]:
                await connection.send_text(message)

    async def broadcast_to_space(self, message: str, space_id: int, user_ids: List[int]):
        for user_id in user_ids:
            await self.send_personal_message(message, user_id)

# WebSocketè·¯ç”±
@app.websocket("/ws/{user_id}")
async def websocket_endpoint(
    websocket: WebSocket,
    user_id: int,
    token: str = Query(...),
    db: AsyncSession = Depends(get_db)
):
    # éªŒè¯token
    user = await auth_service.verify_token(token)
    if not user or user.id != user_id:
        await websocket.close(code=4001)
        return

    await manager.connect(websocket, user_id)

    try:
        while True:
            data = await websocket.receive_text()
            message = json.loads(data)

            # å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
            if message["type"] == "chat":
                await handle_chat_message(message, user_id, db)
            elif message["type"] == "collaboration":
                await handle_collaboration_message(message, user_id, db)

    except WebSocketDisconnect:
        manager.disconnect(websocket, user_id)
```

## å››ã€éƒ¨ç½²æ¶æ„

### 4.1 å®¹å™¨åŒ–éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  # åç«¯æœåŠ¡
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/secondbrain
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
    depends_on:
      - postgres
      - redis
      - minio

  # æ•°æ®åº“æœåŠ¡
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: secondbrain
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # ç¼“å­˜æœåŠ¡
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  # å¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data

  # å‘é‡æ•°æ®åº“
  qdrant:
    image: qdrant/qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

  # æ¶ˆæ¯é˜Ÿåˆ—
  kafka:
    image: confluentinc/cp-kafka:latest
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
    depends_on:
      - zookeeper

  # Celery Worker
  celery_worker:
    build: .
    command: celery -A app.core.celery worker --loglevel=info
    depends_on:
      - redis
      - postgres

  # Celery Beat
  celery_beat:
    build: .
    command: celery -A app.core.celery beat --loglevel=info
    depends_on:
      - redis
      - postgres

volumes:
  postgres_data:
  redis_data:
  minio_data:
  qdrant_data:
```

### 4.2 ç”Ÿäº§ç¯å¢ƒé…ç½®

```python
# app/core/config.py
from pydantic_settings import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    # åŸºç¡€é…ç½®
    APP_NAME: str = "Second Brain"
    VERSION: str = "1.0.0"
    API_V1_STR: str = "/api/v1"

    # å®‰å…¨é…ç½®
    SECRET_KEY: str
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30

    # æ•°æ®åº“é…ç½®
    DATABASE_URL: str
    REDIS_URL: str

    # å¯¹è±¡å­˜å‚¨
    MINIO_ENDPOINT: str
    MINIO_ACCESS_KEY: str
    MINIO_SECRET_KEY: str
    MINIO_SECURE: bool = False

    # å‘é‡æ•°æ®åº“
    QDRANT_HOST: str = "localhost"
    QDRANT_PORT: int = 6333

    # APIé™æµ
    RATE_LIMIT_FREE_USER: int = 20  # æ¯æ—¥é™åˆ¶
    RATE_LIMIT_PREMIUM_USER: int = 200  # æ¯æ—¥é™åˆ¶

    # AIæä¾›å•†é…ç½®
    OPENAI_API_KEY: Optional[str] = None
    ANTHROPIC_API_KEY: Optional[str] = None
    GEMINI_API_KEY: Optional[str] = None
    DEEPSEEK_API_KEY: Optional[str] = None
    PERPLEXITY_API_KEY: Optional[str] = None

    # æ—¥å¿—é…ç½®
    LOG_LEVEL: str = "INFO"
    LOG_FORMAT: str = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

    class Config:
        env_file = ".env"

settings = Settings()
```

## äº”ã€å¼€å‘è®¡åˆ’ä¸é‡Œç¨‹ç¢‘

### Phase 1: åŸºç¡€æ¶æ„ (2-3å‘¨)

- [ ]  é¡¹ç›®åˆå§‹åŒ–å’ŒåŸºç¡€é…ç½®
- [ ]  æ•°æ®åº“æ¨¡å‹è®¾è®¡å’Œè¿ç§»
- [ ]  è®¤è¯æˆæƒç³»ç»Ÿ
- [ ]  åŸºç¡€APIæ¡†æ¶æ­å»º
- [ ]  Dockerç¯å¢ƒé…ç½®

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ (4-5å‘¨)

- [ ]  Chatæ¨¡å¼å®ç°
- [ ]  Searchæ¨¡å¼é›†æˆ
- [ ]  Thinkæ¨¡å¼å¼€å‘
- [ ]  æ–‡æ¡£ä¸Šä¼ å’Œè§£æ
- [ ]  Spaceç®¡ç†åŠŸèƒ½

### Phase 3: é«˜çº§åŠŸèƒ½ (4-5å‘¨)

- [ ]  AI Agentç³»ç»Ÿ
- [ ]  çŸ¥è¯†å›¾è°±æ„å»º
- [ ]  æ–‡æ¡£ç¿»è¯‘åŠŸèƒ½
- [ ]  åä½œåŠŸèƒ½
- [ ]  WebSocketå®æ—¶é€šä¿¡

### Phase 4: ä¼˜åŒ–ä¸æ‰©å±• (3-4å‘¨)

- [ ]  æ€§èƒ½ä¼˜åŒ–
- [ ]  ç¼“å­˜ç­–ç•¥
- [ ]  ç›‘æ§å’Œæ—¥å¿—
- [ ]  æµ‹è¯•è¦†ç›–
- [ ]  éƒ¨ç½²å’Œè¿ç»´

## å…­ã€å…³é”®æŠ€æœ¯æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ

### 6.1 å¤§æ–‡ä»¶å¤„ç†

- **æŒ‘æˆ˜**: å¤„ç†å¤§å‹PDFã€è§†é¢‘ç­‰æ–‡ä»¶

- **è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨æµå¼ä¸Šä¼ 
  - åˆ†å—å¤„ç†
- åå°å¼‚æ­¥ä»»åŠ¡

### 6.2 å®æ—¶åä½œ

- **æŒ‘æˆ˜**: å¤šç”¨æˆ·åŒæ—¶ç¼–è¾‘å†²çª

- **è§£å†³æ–¹æ¡ˆ**:
- æ“ä½œè½¬æ¢(OT)ç®—æ³•
  - CRDTæ•°æ®ç»“æ„
- WebSocketå®æ—¶åŒæ­¥

### 6.3 AIå“åº”å»¶è¿Ÿ

- **æŒ‘æˆ˜**: AIæ¨¡å‹å“åº”æ—¶é—´é•¿

- **è§£å†³æ–¹æ¡ˆ**:
- æµå¼å“åº”
  - ç¼“å­˜å¸¸è§æŸ¥è¯¢
- æ¨¡å‹é¢„çƒ­

### 6.4 å‘é‡æœç´¢æ€§èƒ½

- **æŒ‘æˆ˜**: å¤§è§„æ¨¡å‘é‡æœç´¢æ•ˆç‡

- **è§£å†³æ–¹æ¡ˆ**:
- å‘é‡ç´¢å¼•ä¼˜åŒ–
  - åˆ†ç‰‡ç­–ç•¥
- æ··åˆæœç´¢(å‘é‡+å…³é”®è¯)